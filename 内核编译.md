# Linux å†…æ ¸ç¼–è¯‘å®Œæ•´æµç¨‹ ğŸš€

## 1. ç¯å¢ƒå‡†å¤‡

> âš ï¸ æ³¨æ„ï¼šæ¯æ¬¡æ‰“å¼€ç»ˆç«¯éƒ½éœ€è¦é‡æ–°æ‰§è¡Œç¯å¢ƒå˜é‡è®¾ç½®

### 1.1 è®¾ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒ
```bash
export ARCH=arm
export CROSS_COMPILE=/usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-
```

### 1.2 å®‰è£…å¿…è¦å·¥å…·
> ğŸ’¡ æç¤ºï¼šæ­¤æ­¥éª¤åªéœ€æ‰§è¡Œä¸€æ¬¡

```bash
sudo apt-get install lzop bison flex libssl-dev libncurses5-dev bc
```
## 2. å†…æ ¸é…ç½®
> ğŸ’¡ æç¤ºï¼šæ­¤æ­¥éª¤åªéœ€æ‰§è¡Œä¸€æ¬¡

```bash
# è¿›å…¥å†…æ ¸æºç ç›®å½•
cd ~/imx6ull/linux-imx-rel_imx_4.1.15_2.1.0_ga

# ä½¿ç”¨é»˜è®¤é…ç½®
make imx_v7_defconfig
```
## 3. DTC ä¿®å¤
> âš ï¸ é‡è¦ï¼šè¿™æ˜¯å…³é”®æ­¥éª¤ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§é¡ºåºæ‰§è¡Œ

### 3.1 ä¿®æ”¹è§£æå™¨æ–‡ä»¶
```bash
# ä¿®æ”¹ dtc-parser.y - æ³¨é‡Šæ‰ yylloc å®šä¹‰
sed -i 's/^YYLTYPE yylloc;$/\/\/ YYLTYPE yylloc;/' scripts/dtc/dtc-parser.y

# ä¿®æ”¹ dtc-parser.y - ä¿®å¤ print_error å‡½æ•°
sed -i 's/srcpos_verror(&yylloc,/srcpos_verror(NULL,/' scripts/dtc/dtc-parser.y
```

### 3.2 ç¡®ä¿è¯æ³•åˆ†æå™¨å®šä¹‰
```bash
# ç¡®ä¿ dtc-lexer.l ä¸­æœ‰ yylloc å®šä¹‰
if ! grep -q "YYLTYPE yylloc;" scripts/dtc/dtc-lexer.l; then
    sed -i '/#include "dtc-parser.tab.h"/a\YYLTYPE yylloc;' scripts/dtc/dtc-lexer.l
fi
```

### 3.3 é‡æ–°ç”Ÿæˆè§£æå™¨
```bash
# åˆ é™¤æ—§çš„è§£æå™¨æ–‡ä»¶
cd scripts/dtc
rm -f dtc-parser.tab.c dtc-parser.tab.h dtc-lexer.lex.c

# é‡æ–°ç”Ÿæˆè§£æå™¨æ–‡ä»¶
bison -d dtc-parser.y -o dtc-parser.tab.c
flex -o dtc-lexer.lex.c dtc-lexer.l

# è¿”å›å†…æ ¸ç›®å½•
cd ../..
```

### 3.4 ä¿®å¤ç”Ÿæˆçš„æ–‡ä»¶
```bash
# ä¿®å¤ dtc-parser.tab.c æ–‡ä»¶
sed -i 's/^YYLTYPE yylloc;$/\/\/ YYLTYPE yylloc;/' scripts/dtc/dtc-parser.tab.c

# ä¿®å¤ dtc-lexer.lex.c æ–‡ä»¶
if ! grep -q "YYLTYPE yylloc;" scripts/dtc/dtc-lexer.lex.c; then
    sed -i '/#include "dtc-parser.tab.h"/a\YYLTYPE yylloc;' scripts/dtc/dtc-lexer.lex.c
fi
```
## 4. ç¼–è¯‘å†…æ ¸

```bash
# ç¼–è¯‘å†…æ ¸é•œåƒ
make -j$(nproc) zImage

# ç¼–è¯‘è®¾å¤‡æ ‘
make -j$(nproc) dtbs

# ç¼–è¯‘æ¨¡å—ï¼ˆå¯é€‰ï¼‰
make -j$(nproc) modules
```
## 5. éªŒè¯ç¼–è¯‘ç»“æœ

```bash
# æ£€æŸ¥å†…æ ¸é•œåƒ
ls -lh arch/arm/boot/zImage
echo "ç¼–è¯‘æˆåŠŸï¼ç”Ÿæˆæ–‡ä»¶: arch/arm/boot/zImage"

# æ£€æŸ¥è®¾å¤‡æ ‘æ–‡ä»¶
ls arch/arm/boot/dts/ | grep imx6ull

# æ£€æŸ¥æ–‡ä»¶ç±»å‹
file arch/arm/boot/zImage
```
## ä¸åŒåœºæ™¯çš„ç¼–è¯‘æµç¨‹ ğŸ”„

### åœºæ™¯1ï¼šé¦–æ¬¡å®Œæ•´ç¼–è¯‘
> æŒ‰é¡ºåºæ‰§è¡Œä¸Šè¿°æ‰€æœ‰æ­¥éª¤ï¼ˆç¬¬1æ­¥åˆ°ç¬¬5æ­¥ï¼‰

### åœºæ™¯2ï¼šä¿®æ”¹ä»£ç åé‡æ–°ç¼–è¯‘
```bash
export ARCH=arm
export CROSS_COMPILE=/usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-
make -j$(nproc) zImage
```

### åœºæ™¯3ï¼šä¿®æ”¹é…ç½®åé‡æ–°ç¼–è¯‘
```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
export ARCH=arm
export CROSS_COMPILE=/usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-

# 2. æ›´æ–°é…ç½®
make imx_v7_defconfig

# 3. é‡è¦ï¼å¿…é¡»é‡æ–°æ‰§è¡Œç¬¬3æ­¥ï¼ˆDTCä¿®å¤ï¼‰
# 4. ç„¶åæ‰§è¡Œç¬¬4æ­¥ç¼–è¯‘
```

### åœºæ™¯4ï¼šæ¸…ç†åé‡æ–°ç¼–è¯‘
```bash
# è½»åº¦æ¸…ç†ï¼ˆä¿ç•™é…ç½®ï¼‰
make clean

# é‡æ–°ç¼–è¯‘
make -j$(nproc) zImage
```
## é‡è¦æ³¨æ„äº‹é¡¹ âš ï¸

1. **ç¯å¢ƒå˜é‡è®¾ç½®**
   - æ¯æ¬¡æ–°ç»ˆç«¯ä¼šè¯éƒ½éœ€è¦é‡æ–°è®¾ç½®ç¯å¢ƒå˜é‡
   - æ–°ä¼šè¯ä¼šä¸¢å¤±ä¹‹å‰çš„è®¾ç½®

2. **é…ç½®ä¿®æ”¹**
   - ä¿®æ”¹é…ç½®åå¿…é¡»é‡æ–°åº”ç”¨DTCä¿®å¤
   - è¿™æ˜¯å› ä¸ºé…ç½®æ›´æ”¹ä¼šé‡æ–°ç”Ÿæˆè§£æå™¨æ–‡ä»¶

3. **æ¸…ç†æ³¨æ„**
   - ä¸è¦ä½¿ç”¨ `make distclean`
   - è¯¥å‘½ä»¤ä¼šåˆ é™¤æ‰€æœ‰é…ç½®æ–‡ä»¶ï¼Œéœ€è¦ä»å¤´å¼€å§‹

4. **å‘½ä»¤æ‰§è¡ŒéªŒè¯**
   - ç¡®ä¿æ‰€æœ‰sedå‘½ä»¤æ‰§è¡ŒæˆåŠŸ
   - æ¯æ¬¡ä¿®æ”¹åéƒ½è¦æ£€æŸ¥æ˜¯å¦æ­£ç¡®åº”ç”¨

## ç¼–è¯‘æˆåŠŸæ ‡å¿— ğŸ¯

1. å‡ºç°ä»¥ä¸‹æç¤ºï¼š
   ```text
   Kernel: arch/arm/boot/zImage is ready
   ```

2. æ£€æŸ¥ç”Ÿæˆæ–‡ä»¶ï¼š
   ```bash
   ls -lh arch/arm/boot/zImage
   # åº”è¯¥æ˜¾ç¤ºä¸€ä¸ªå‡ MBå¤§å°çš„æ–‡ä»¶
   ```

## å…³é”®ä¿®æ”¹æ€»ç»“ ğŸ“

1. DTCè§£æå™¨ä¿®æ”¹ï¼š
   - æ³¨é‡Šæ‰ `dtc-parser.y` ä¸­çš„ `YYLTYPE yylloc;`
   - ä¿®æ”¹ `dtc-parser.y` ä¸­çš„ `srcpos_verror(&yylloc,` ä¸º `srcpos_verror(NULL,`

2. è¯æ³•åˆ†æå™¨ä¿®æ”¹ï¼š
   - ç¡®ä¿ `dtc-lexer.l` ä¸­æœ‰ `YYLTYPE yylloc;` å®šä¹‰
   - é‡æ–°ç”Ÿæˆå¹¶ä¿®å¤è§£æå™¨æ–‡ä»¶

---

> ğŸŒŸ æç¤ºï¼šæŒ‰ç…§è¿™ä¸ªå®Œæ•´æµç¨‹ï¼Œé€æ­¥æ‰§è¡Œï¼Œæ¯ä¸ªæ­¥éª¤éƒ½å¾ˆé‡è¦ï¼Œä¸è¦è·³è¿‡ä»»ä½•ä¸€æ­¥ï¼



#  Linuxä¸‹æŠŠé©±åŠ¨ç¼–è¯‘è¿›å†…æ ¸
================================

é‡åˆ°äº†å¦‚ä¸‹æŠ¥é”™

``` bash
HOSTCC  scripts/dtc/dtc-parser.tab.o
dtc-parser.y: In function â€˜print_errorâ€™:
dtc-parser.y:478:17: error: â€˜yyllocâ€™ undeclared (first use in this function); did you mean â€˜yyallocâ€™?
dtc-parser.y:478:17: note: each undeclared identifier is reported only once for each function it appears in
make[2]: *** [scripts/Makefile.host:108ï¼šscripts/dtc/dtc-parser.tab.o] é”™è¯¯ 1
make[1]: *** [scripts/Makefile.build:403ï¼šscripts/dtc] é”™è¯¯ 2
make: *** [Makefile:555ï¼šscripts] é”™è¯¯ 2
```


ğŸš¨ é—®é¢˜åˆ†æ
create.sh è„šæœ¬é‡æ–°è¿è¡Œäº†é…ç½®ï¼šconfiguration written to .config

è¿™é‡æ–°ç”Ÿæˆäº† dtc è§£æå™¨æ–‡ä»¶ï¼Œè¦†ç›–äº†ä½ çš„ä¿®å¤

å¯¼è‡´ yylloc undeclared é”™è¯¯å†æ¬¡å‡ºç°


ğŸ”§ è§£å†³æ–¹æ¡ˆ
```bash
# é¦–å…ˆå¤‡ä»½ create.sh
cp create.sh create.sh.backup

# ç¼–è¾‘ create.shï¼Œåœ¨é…ç½®å‘½ä»¤åæ·»åŠ  dtc ä¿®å¤
vim create.sh
```

åœ¨è„šæœ¬ä¸­æ‰¾åˆ°é…ç½®å‘½ä»¤ï¼ˆå¯èƒ½æ˜¯ make imx_v7_defconfig æˆ–ç±»ä¼¼å‘½ä»¤ï¼‰ï¼Œåœ¨å…¶åæ·»åŠ ï¼š

```bash
# æ·»åŠ  dtc ä¿®å¤ä»£ç 
echo "Applying dtc fixes..."
sed -i 's/^YYLTYPE yylloc;$/\/\/ YYLTYPE yylloc;/' scripts/dtc/dtc-parser.y
sed -i 's/srcpos_verror(&yylloc,/srcpos_verror(NULL,/' scripts/dtc/dtc-parser.y

# é‡æ–°ç”Ÿæˆè§£æå™¨æ–‡ä»¶
cd scripts/dtc
rm -f dtc-parser.tab.c dtc-parser.tab.h
bison -d dtc-parser.y -o dtc-parser.tab.c
cd ../..

# ä¿®å¤ç”Ÿæˆçš„æ–‡ä»¶
sed -i 's/^YYLTYPE yylloc;$/\/\/ YYLTYPE yylloc;/' scripts/dtc/dtc-parser.tab.c
```



**ç”Ÿæˆè®¾å¤‡æ ‘æ–‡ä»¶**
```bash
make topeet_emmc_4_3.dtb
make topeet_emmc_5_0.dtb
make topeet_emmc_7_0.dtb
make topeet_emmc_1024x600.dtb
make topeet_emmc_9_7.dtb
make topeet_emmc_10_1.dtb
make topeet_emmc_hdmi.dtb
```
